# Session Notes — 2026-02-22

## What We Did
- Merged `claude/work-in-progress-cOvj1` branch into `main` (fast-forward merge: added CharacterSidebar, chat layout route, seed fix)
- Pushed merged main to origin
- Set up local dev environment: Docker Postgres, npm install, Prisma generate/migrate/seed
- Added real Anthropic and OpenAI API keys to `.env`
- Debugged and fixed a critical env var loading issue — Gandalf is now talking!

## Bug Fix: Vite SSR Env Var Loading

**Problem:** `process.env.ANTHROPIC_API_KEY` was empty string (`""`) at runtime in server-side code, causing `AnthropicError: Could not resolve authentication method`.

**Root cause:** Vite reads `.env` and actively sets all non-`VITE_`-prefixed env vars to **empty strings** in the SSR (server-side rendering) process. Since `dotenv` doesn't overwrite existing env vars by default, `import "dotenv/config"` was a no-op — it saw the key already existed (as `""`) and skipped it.

**Fix:** In `app/lib/ai.server.ts`, use dotenv with `override: true`:
```typescript
import { config } from "dotenv";
import { resolve } from "path";
config({ path: resolve(process.cwd(), ".env"), override: true });
```

**Key lesson:** In React Router v7 / Vite projects, `VITE_` prefix is for client-side vars only. Server-side code needs dotenv with `override: true` because Vite's SSR zeroes out non-prefixed vars before your code runs.

## Current State
- App is fully functional locally at http://localhost:5173/
- All three characters seeded (Gandalf, Sherlock Holmes, Darth Vader)
- AI streaming working with Anthropic (Claude Sonnet)
- Auth working (signup/login/logout)
- CharacterSidebar added for switching between characters

## Files Modified This Session
- `vite.config.ts` — added `import "dotenv/config"` (belt-and-suspenders, mainly for vite config process itself)
- `app/lib/ai.server.ts` — added dotenv `config({ override: true })` to fix SSR env vars
- `.env` — added real API keys (not committed, in .gitignore)
